{% if enable_comments_plugin %}
    {% set scope = scope ?: 'data.' %}

    <h3>{{'PLUGIN_ADVANCED_COMMENTS.ADD_COMMENT'|t}}</h3>

    <form name="{{ grav.config.plugins['advanced-comments'].form.name }}"
          action="{{ grav.config.plugins['advanced-comments'].form.action ?  base_url ~ grav.config.plugins.advanced_comments.form.action : page.url }}"
          method="{{ grav.config.plugins['advanced-comments'].form.method ? grav.config.plugins['advanced-comments'].form.method|upper|default('POST') : 'POST' }}">

        {% for field in grav.config.plugins['advanced-comments'].form.fields %}
            {% set value = form.value(field.name) %}
            {% if field.evaluateDefault %}
                {% set value = evaluate(field.evaluateDefault) %}
            {% endif %}
            {% if config.plugins.login.enabled and grav.user.authenticated %}
                {% if field.name == 'name' %}
                    <input type="hidden" name="{{ (scope ~ field.name)|fieldName }}" value="{{grav.user.fullname}}">
                {% elseif field.name == 'email' %}
                    <input type="hidden" name="{{ (scope ~ field.name)|fieldName }}" value="{{grav.user.email}}">
                {% else %}
                    <div>
                        {% include "forms/fields/#{field.type}/#{field.type}.html.twig" %}
                    </div>
                {% endif %}
            {% else %}
                <div>
                    {% include "forms/fields/#{field.type}/#{field.type}.html.twig" %}
                </div>
            {% endif %}
        {% endfor %}
        {% include "forms/fields/formname/formname.html.twig" %}

        <div class="buttons">
        {% for button in grav.config.plugins['advanced-comments'].form.buttons %}
            <button class="button" type="{{ button.type|default('submit') }}">{{ button.value|t|default('Submit') }}</button>
        {% endfor %}
        </div>

        {{ nonce_field('form', 'form-nonce')|raw }}
    </form>

    <div class="alert">{{ form.message }}</div>

    {% if grav.twig.comments|length %}
        <h3>{{'PLUGIN_ADVANCED_COMMENTS.COMMENTS'|t}}</h3>

        <div class="comments">
            {% for comment in comments|array_reverse %}
            <div class="comment">
                <div class="comment-details">
                    <span class="comment-author">{{ comment.author }}</span> <span class="comment-date">{{ comment.date|e }}</span>
                </div>
                <div class="comment-text">{{ comment.text|striptags('<p><b><u><i><a><br>')|raw }}</div>

                {% if comment.replies|length > 0 %}
                    {% for reply in comment.replies %}
                    <div class="reply">
                        <div class="comment-details">
                            <span class="comment-author">{{ reply.author ?? grav.config.site.title  }}</span> <span class="comment-date">{{ reply.date|e }}</span>
                        </div>
                        <div class="comment-text">
                            {{ reply.text|striptags('<p><b><u><i><a><br>')|raw }}</div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            {% endfor %}
        </div>
    {% endif %}
{% endif %}
